<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Week 10 – PT Commuting (ABS 2021): Bars + Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    :root { --fg:#0f172a; --muted:#475569; --ocean:#eef6fb; --grid:#cdd6de; }
    body { font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; color: var(--fg); }
    h1 { margin: 0 0 6px; font-size: 22px; }
    h2 { margin: 18px 0 6px; font-size: 18px; }
    .wrap { max-width: 1060px; margin: 0 auto; }
    .section { background:#fff; padding: 10px 0 4px; }
    .caption { margin: 8px 0 16px; font-size: 13px; color: var(--muted); }
    .vis { width: 100%; }
    .two-col { display: grid; grid-template-columns: 1fr; gap: 22px; }
    @media (min-width: 980px) {
      .two-col { grid-template-columns: 1fr; } /* keep single column for clarity */
    }
    .footer { margin-top: 12px; font-size: 13px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">

    <h1>Public Transport Commuting — ABS Census 2021</h1>
    <div class="caption">
      Dataset: % of employed commuters who used train, bus, ferry, or tram/light rail on Census day. Source: ABS 2021 (MTWP).
    </div>

    <!-- Task 1: Horizontal bar chart -->
    <div class="section">
      <h2>Task 1 — Bar Chart (Interactive)</h2>
      <div id="vis-bars" class="vis" aria-label="Horizontal bar chart of PT commuting by state"></div>
      <div class="caption">Interaction: tooltips, value labels, slider filter (0–8%).</div>
    </div>

    <!-- Task 2: Map (Week 9 map reused) -->
    <div class="section">
      <h2>Task 2 — Choropleth Map</h2>
      <div id="vis-map" class="vis" aria-label="Choropleth map of PT commuting by state"></div>
      <div class="caption">Includes ocean background and graticule; same metric as the bar chart for direct comparison.</div>
    </div>

    <div class="footer">
      Source: ABS Census 2021 (Method of Travel to Work, MTWP). Geography: Natural Earth Admin-1 (simplified).
    </div>
  </div>

  <script>
    const csvUrl  = "data/au-pt-commuting-2021.csv";
    const topoUrl = "data/au-states.json"; // expects objects.states

    // (Optional) quick sanity log
    Promise.all([
      fetch(csvUrl).then(r=>({url:csvUrl, ok:r.ok, status:r.status})).catch(e=>({url:csvUrl, ok:false, error:String(e)})),
      fetch(topoUrl).then(r=>({url:topoUrl, ok:r.ok, status:r.status})).catch(e=>({url:topoUrl, ok:false, error:String(e)}))
    ]).then(x=>console.table(x));

    /* ---------------------------
       Spec A — Week 10 Task 1 Bars
       --------------------------- */
    const specBars = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "description": "Horizontal bar chart with tooltips, labels, and slider filter.",
      "width": 980,
      "height": 380,
      "data": { "url": csvUrl },
      "params": [
        {
          "name": "pctMin_task1",
          "value": 0,
          "bind": { "input": "range", "min": 0, "max": 8, "step": 0.1, "name": "Minimum % using PT: " }
        }
      ],
      "transform": [
        { "filter": { "field": "state_name", "oneOf": [
          "New South Wales","Victoria","Queensland","South Australia",
          "Western Australia","Tasmania","Northern Territory","Australian Capital Territory"
        ]}},
        { "calculate": "toNumber(datum.pct_pt)", "as": "pct_num" },
        { "filter": "datum.pct_num >= pctMin_task1" }
      ],
      "layer": [
        {
          "mark": { "type": "bar", "cornerRadiusEnd": 3 },
          "encoding": {
            "y": { "field": "state_name", "type": "nominal", "title": "State / Territory", "sort": "-x" },
            "x": { "field": "pct_num", "type": "quantitative", "title": "% commuters using public transport", "axis": { "format": ".1f" } },
            "color": { "value": "#4f9dda" },
            "tooltip": [
              { "field": "state_name", "title": "State/Territory" },
              { "field": "pt_commuters", "title": "PT commuters", "format": "," },
              { "field": "total_commuters", "title": "Total commuters", "format": "," },
              { "field": "pct_num", "title": "% using PT", "format": ".1f" }
            ]
          }
        },
        {
          "mark": { "type": "text", "align": "left", "dx": 4, "baseline": "middle", "fontSize": 12 },
          "encoding": {
            "y": { "field": "state_name", "type": "nominal", "sort": "-x" },
            "x": { "field": "pct_num", "type": "quantitative" },
            "text": { "field": "pct_num", "type": "quantitative", "format": ".1f" },
            "color": { "value": "#0f172a" }
          }
        },
        {
          "transform": [{ "aggregate": [{ "op": "mean", "field": "pct_num", "as": "avg_pct" }] }],
          "mark": { "type": "rule", "stroke": "#64748b", "strokeDash": [5,4], "strokeWidth": 1 },
          "encoding": { "x": { "field": "avg_pct", "type": "quantitative" } }
        },
        {
          "transform": [{ "aggregate": [{ "op": "mean", "field": "pct_num", "as": "avg_pct" }] }],
          "mark": { "type": "text", "align": "left", "dx": -30, "dy": -8, "fontSize": 12, "color": "#475569" },
          "encoding": {
            "x": { "field": "avg_pct", "type": "quantitative" },
            "y": { "value": -5 },
            "text": { "value": "National avg: 4.6" }
          }
        }
      ],
      "config": {
        "view": { "stroke": null },
        "axis": { "labelFontSize": 12, "titleFontSize": 12 },
        "bar": { "size": 22 }
      }
    };

    /* ---------------------------
       Spec B — Week 9 Map (clean)
       --------------------------- */
    const specMap = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "description": "Choropleth map: % PT commuters by state (ABS 2021).",
      "width": 980,
      "height": 600,
      "projection": { "type": "mercator", "center": [134, -28.5], "scale": 800 },
      "layer": [
        { "data": { "graticule": "sphere" }, "mark": { "type": "geoshape", "fill": "#eef6fb" } },
        { "data": { "graticule": { "step": [30, 30] } }, "mark": { "type": "geoshape", "stroke": "#cdd6de", "strokeWidth": 0.6 } },
        {
          "data": { "url": topoUrl, "format": { "type": "topojson", "feature": "states" } },
          "transform": [
            { "filter": { "field": "properties.name", "oneOf": [
              "New South Wales","Victoria","Queensland","South Australia",
              "Western Australia","Tasmania","Northern Territory","Australian Capital Territory"
            ] } },
            { "lookup": "properties.name",
              "from": { "data": { "url": csvUrl }, "key": "state_name", "fields": ["pct_pt","pt_commuters","total_commuters"] } },
            { "calculate": "isValid(datum.pct_pt) ? toNumber(datum.pct_pt) : 0", "as": "pct_safe" }
          ],
          "mark": { "type": "geoshape", "stroke": "#ffffff", "strokeWidth": 1 },
          "encoding": {
            "color": {
              "field": "pct_safe", "type": "quantitative",
              "title": "% commuters using public transport",
              "scale": { "scheme": "blues" },
              "legend": { "orient": "bottom", "direction": "horizontal" }
            },
            "tooltip": [
              { "field": "properties.name", "title": "State/Territory" },
              { "field": "pt_commuters", "title": "PT commuters", "format": "," },
              { "field": "total_commuters", "title": "Total commuters", "format": "," },
              { "field": "pct_safe", "title": "% using PT", "format": ".1f" }
            ]
          }
        }
      ],
      "config": { "view": { "stroke": null }, "legend": { "titleFontSize": 12, "labelFontSize": 11, "titleLimit": 320, "padding": 4 } }
    };

    /* Embed both (separate, to avoid param/signal collisions) */
    vegaEmbed("#vis-bars", specBars, { actions: false })
      .then(() => console.log("Rendered Task 1 (bars)"))
      .catch(err => console.error("Vega error (bars):", err));

    vegaEmbed("#vis-map", specMap, { actions: false })
      .then(() => console.log("Rendered Task 2 (map)"))
      .catch(err => console.error("Vega error (map):", err));
  </script>
</body>
</html>
